#!/usr/bin/env ruby
# frozen_string_literal: true

require "pathname"

def run(*cmd)
  puts "Running `#{cmd.join(" ")}`" if ENV["CI"]
  return if system(*cmd, :out => IO::NULL)
  raise "Running `#{cmd.join(" ")}` failed"
end

version = ENV.delete("RGV")
rubygems_path = Pathname.new(version).expand_path
unless rubygems_path.directory?
  rubygems_path = Pathname.new("tmp/rubygems").expand_path
  unless rubygems_path.directory?
    rubygems_path.parent.mkpath unless rubygems_path.directory?
    run("git", "clone", "--recursive", "https://github.com/rubygems/rubygems.git", rubygems_path.to_s)
  end
end

Dir.chdir(rubygems_path) do
  run("git remote update")
  version = "v#{version}" if version =~ /\A\d/
  run("git", "checkout", version, "--quiet")
  run("git", "submodule", "update", "--init", "--recursive")

  if ENV["CI"]
    run("ruby", "setup.rb")
  else
    rubygems_lib = rubygems_path + "lib"
    ENV["RUBYOPT"] = %(-I#{rubygems_lib} #{ENV["RUBYOPT"]})
  end
end

if $0 != __FILE__
  ARGV.unshift($0)
elsif cmd = ARGV.first
  possible_dirs = [
    Pathname.new(__FILE__) + "..",
    Pathname.new(__FILE__) + "../../exe",
    rubygems_path + "bin",
  ]
  cmd = possible_dirs.map do |dir|
    dir.join(cmd).expand_path
  end.find(&:file?)
  ARGV[0] = cmd.to_s if cmd
end

exec(*ARGV)
